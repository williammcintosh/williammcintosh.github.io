<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Google Drive Files</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
  </head>
  <!-- Google tag (gtag.js) -->
  <script
    async
    src="https://www.googletagmanager.com/gtag/js?id=G-QQM8BW242M"
  ></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'G-QQM8BW242M');
  </script>
  <body class="is-preload">
    <!-- Nav -->
    <nav id="nav">
      <div class="container">
        <div class="nav-header">
          <button class="nav-toggle" id="nav-toggle">â˜°</button>
        </div>
      </div>
    </nav>

    <h1>Google Drive Files</h1>
    <ul id="drive-files"></ul>

    <!-- Try loading GitHub Secrets first, then fall back to local file -->
    <script>
      async function getApiKey() {
        // Detect if running Netlify Dev locally
        const isLocalNetlify = window.location.hostname === 'localhost';

        // Set the correct API endpoint
        const secretUrl = isLocalNetlify
          ? 'http://localhost:8888/.netlify/functions/get-secret' // Local Netlify function
          : '/.netlify/functions/get-secret'; // Production Netlify function

        try {
          console.log('Fetching API key from:', secretUrl);
          const response = await fetch(secretUrl);
          if (response.ok) {
            const data = await response.json();
            if (data.apiKey === 'API_KEY_NOT_SET') {
              throw new Error('Netlify environment variable not set.');
            }
            return data.apiKey;
          } else {
            throw new Error('Netlify function not available.');
          }
        } catch (error) {
          console.error('Failed to fetch API key:', error.message);
          return null;
        }
      }

      const DRIVE_FOLDER_ID = '1x2iC7QAf8vH2rRu4jg_OU-KOACls8zNz'; // Define the folder ID

      async function fetchDriveFiles() {
        const apiKey = await getApiKey();
        if (!apiKey) {
          console.error('Failed to fetch API key. Stopping execution.');
          return;
        }

        const url = `https://www.googleapis.com/drive/v3/files?q='${DRIVE_FOLDER_ID}'+in+parents&key=${apiKey}`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          const filesList = document.getElementById('drive-files');

          if (!filesList) {
            console.error("Error: Element with ID 'drive-files' not found.");
            return;
          }

          if (data.files && data.files.length > 0) {
            data.files.forEach((file) => {
              const li = document.createElement('li');
              li.innerHTML = `<a href="https://drive.google.com/uc?export=view&id=${file.id}" target="_blank">${file.name}</a>`;
              filesList.appendChild(li);
            });
          } else {
            filesList.innerHTML = '<li>No files found.</li>';
          }
        } catch (error) {
          console.error('Error fetching files:', error);
        }
      }

      fetchDriveFiles();
    </script>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrolly.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
  </body>
</html>
