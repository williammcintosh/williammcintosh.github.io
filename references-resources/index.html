<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Google Drive Files</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
  </head>
  <!-- Google tag (gtag.js) -->
  <script
    async
    src="https://www.googletagmanager.com/gtag/js?id=G-QQM8BW242M"
  ></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'G-QQM8BW242M');
  </script>
  <body class="is-preload">
    <!-- Nav -->
    <nav id="nav">
      <div class="container">
        <div class="nav-header">
          <button class="nav-toggle" id="nav-toggle">â˜°</button>
        </div>
      </div>
    </nav>

    <h1>Google Drive Files</h1>
    <ul id="drive-files"></ul>

    <!-- Try loading GitHub Secrets first, then fall back to local file -->
    <script>
      async function getApiKey() {
        // Check if running on Netlify (production mode)
        const isProduction =
          window.location.hostname !== '127.0.0.1' &&
          window.location.hostname !== 'localhost';

        if (isProduction) {
          try {
            // Try fetching API key from GitHub Secrets
            const response = await fetch('/.netlify/functions/get-secret');
            if (response.ok) {
              const data = await response.json();
              return data.apiKey; // API key from GitHub Secrets
            } else {
              throw new Error('GitHub Secrets not available');
            }
          } catch (error) {
            console.warn(
              'GitHub Secrets not available, falling back to local API key:',
              error.message
            );
          }
        }

        // Fallback to local api_key.js for development
        try {
          const response = await fetch('/references-resources/api_key.js');
          if (!response.ok) throw new Error('Local API key file not found');

          const text = await response.text();
          const apiKey = text.match(/'([^']+)'/)[1]; // Extract API key from JS file
          return apiKey;
        } catch (error) {
          console.error('No valid API key found:', error.message);
          return null;
        }
      }

      const DRIVE_FOLDER_ID = '1x2iC7QAf8vH2rRu4jg_OU-KOACls8zNz'; // Define the folder ID

      async function fetchDriveFiles() {
        const apiKey = await getApiKey();
        if (!apiKey) {
          console.error('Failed to fetch API key. Stopping execution.');
          return;
        }

        const url = `https://www.googleapis.com/drive/v3/files?q='${DRIVE_FOLDER_ID}'+in+parents&key=${apiKey}`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          const filesList = document.getElementById('drive-files');

          if (!filesList) {
            console.error("Error: Element with ID 'drive-files' not found.");
            return;
          }

          if (data.files && data.files.length > 0) {
            data.files.forEach((file) => {
              const li = document.createElement('li');
              li.innerHTML = `<a href="https://drive.google.com/uc?export=view&id=${file.id}" target="_blank">${file.name}</a>`;
              filesList.appendChild(li);
            });
          } else {
            filesList.innerHTML = '<li>No files found.</li>';
          }
        } catch (error) {
          console.error('Error fetching files:', error);
        }
      }

      fetchDriveFiles();
    </script>

    <script src="references-resources/api_key.js"></script>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrolly.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
  </body>
</html>
